<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading Tips - Simple Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 1rem;
        }

        .login-screen {
            max-width: 500px;
            margin: 5rem auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .admin-interface {
            display: none;
        }

        .header {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            height: fit-content;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .content-area {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9rem;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        textarea.form-control {
            min-height: 300px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }

        .post-list {
            list-style: none;
        }

        .post-list li {
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .post-list li:hover {
            background: #f8f9fa;
        }

        .post-meta {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .editor-actions {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .token-help {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <h1>Loading Tips - Simple Admin</h1>
        
        <div class="token-help">
            <strong>üìù Setup Instructions:</strong>
            <ol style="text-align: left; margin-top: 0.5rem;">
                <li>Go to <a href="https://github.com/settings/tokens/new" target="_blank">GitHub Personal Access Tokens</a></li>
                <li>Create token with <strong>"repo"</strong> scope</li>
                <li>Copy and paste it below</li>
            </ol>
        </div>

        <div class="form-group">
            <input type="password" id="token-field" class="form-control" 
                   placeholder="Paste your GitHub Personal Access Token here">
        </div>
        
        <button id="token-login-btn" class="btn">
            Login with Token
        </button>
        
        <div id="login-error" class="error" style="display: none;"></div>
    </div>

    <!-- Admin Interface -->
    <div id="admin-interface" class="admin-interface">
        <div class="container">
            <div class="header">
                <h1>Loading Tips Admin</h1>
                <div class="user-info">
                    <img id="user-avatar" class="avatar" src="" alt="User Avatar">
                    <div>
                        <div id="user-name">Loading...</div>
                        <button id="logout-btn" class="btn btn-secondary">Logout</button>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="sidebar">
                    <h3>Posts</h3>
                    <button id="new-post-btn" class="btn" style="margin-bottom: 1rem; width: 100%;">
                        New Post
                    </button>
                    
                    <div id="posts-loading" class="loading" style="display: none;">Loading posts...</div>
                    <ul id="posts-list" class="post-list"></ul>
                </div>

                <div class="content-area">
                    <div id="welcome-view">
                        <h2>Welcome to the Admin Panel</h2>
                        <p>Select a post from the sidebar to edit, or click "New Post" to create a new one.</p>
                        <p style="margin-top: 1rem; color: #6c757d;">
                            Your posts are stored in the <code>posts/</code> directory as markdown files.
                        </p>
                    </div>

                    <div id="editor-view" style="display: none;">
                        <div class="editor-actions">
                            <button id="save-btn" class="btn">Save Post</button>
                            <button id="delete-btn" class="btn btn-danger">Delete Post</button>
                            <button id="cancel-btn" class="btn btn-secondary">Cancel</button>
                        </div>

                        <div id="editor-messages"></div>

                        <form id="post-form">
                            <div class="form-group">
                                <label for="post-title">Title</label>
                                <input type="text" id="post-title" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="post-date">Date</label>
                                <input type="date" id="post-date" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="post-content">Content (Markdown)</label>
                                <textarea id="post-content" class="form-control" required 
                                    placeholder="Write your post content in Markdown..."></textarea>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class SimpleGitHubAdmin {
            constructor() {
                // Repository configuration
                this.owner = 'Syrthax';
                this.repo = 'Loading-tips';
                this.postsPath = 'posts';
                
                // Token stored in memory only
                this.accessToken = localStorage.getItem('github_token');
                this.currentUser = null;
                this.posts = [];
                this.currentPost = null;
                this.isNewPost = false;
                
                this.initElements();
                this.bindEvents();
                this.init();
            }

            initElements() {
                this.loginScreen = document.getElementById('login-screen');
                this.adminInterface = document.getElementById('admin-interface');
                this.tokenField = document.getElementById('token-field');
                this.tokenLoginBtn = document.getElementById('token-login-btn');
                this.logoutBtn = document.getElementById('logout-btn');
                this.loginError = document.getElementById('login-error');
                
                this.userAvatar = document.getElementById('user-avatar');
                this.userName = document.getElementById('user-name');
                
                this.postsLoading = document.getElementById('posts-loading');
                this.postsList = document.getElementById('posts-list');
                this.newPostBtn = document.getElementById('new-post-btn');
                
                this.welcomeView = document.getElementById('welcome-view');
                this.editorView = document.getElementById('editor-view');
                this.editorMessages = document.getElementById('editor-messages');
                
                this.postForm = document.getElementById('post-form');
                this.postTitle = document.getElementById('post-title');
                this.postDate = document.getElementById('post-date');
                this.postContent = document.getElementById('post-content');
                
                this.saveBtn = document.getElementById('save-btn');
                this.deleteBtn = document.getElementById('delete-btn');
                this.cancelBtn = document.getElementById('cancel-btn');
            }

            bindEvents() {
                this.tokenLoginBtn.addEventListener('click', () => this.loginWithToken());
                this.logoutBtn.addEventListener('click', () => this.logout());
                this.newPostBtn.addEventListener('click', () => this.createNewPost());
                this.saveBtn.addEventListener('click', () => this.savePost());
                this.deleteBtn.addEventListener('click', () => this.deletePost());
                this.cancelBtn.addEventListener('click', () => this.cancelEdit());
                
                // Enter key in token field
                this.tokenField.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.loginWithToken();
                    }
                });
            }

            async init() {
                if (this.accessToken) {
                    await this.initializeAdmin();
                } else {
                    this.showLogin();
                }
            }

            async loginWithToken() {
                const token = this.tokenField.value.trim();
                
                if (!token) {
                    this.showLoginError('Please enter your GitHub Personal Access Token');
                    return;
                }
                
                try {
                    this.accessToken = token;
                    await this.verifyUser();
                    
                    // Store token
                    localStorage.setItem('github_token', token);
                    
                    this.showAdmin();
                    await this.loadPosts();
                    
                } catch (error) {
                    console.error('Login error:', error);
                    this.showLoginError('Login failed: ' + error.message);
                    this.accessToken = null;
                }
            }

            async verifyUser() {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${this.accessToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Invalid token. Please check your Personal Access Token.');
                    }
                    throw new Error(`GitHub API error: ${response.status}`);
                }

                this.currentUser = await response.json();
                
                // Verify it's you
                if (this.currentUser.login !== 'Syrthax') {
                    throw new Error(`Access denied. This admin panel is only for Syrthax. You are: ${this.currentUser.login}`);
                }
                
                this.updateUserInfo();
            }

            updateUserInfo() {
                this.userAvatar.src = this.currentUser.avatar_url;
                this.userName.textContent = this.currentUser.name || this.currentUser.login;
            }

            async initializeAdmin() {
                try {
                    await this.verifyUser();
                    this.showAdmin();
                    await this.loadPosts();
                } catch (error) {
                    console.error('Admin initialization error:', error);
                    this.showLoginError('Authentication failed: ' + error.message);
                    this.logout();
                }
            }

            // ... [rest of the admin functionality remains the same as the complex version]
            // Copying the essential methods for post management

            async loadPosts() {
                this.postsLoading.style.display = 'block';
                this.postsList.innerHTML = '';
                
                try {
                    const response = await fetch(
                        `https://api.github.com/repos/${this.owner}/${this.repo}/contents/${this.postsPath}`,
                        {
                            headers: {
                                'Authorization': `token ${this.accessToken}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );

                    if (!response.ok) {
                        if (response.status === 404) {
                            this.posts = [];
                            this.renderPostsList();
                            return;
                        }
                        throw new Error(`Failed to load posts: ${response.status}`);
                    }

                    const files = await response.json();
                    
                    const postFiles = files.filter(file => 
                        file.type === 'file' && file.name.endsWith('.md')
                    );

                    this.posts = await Promise.all(
                        postFiles.map(async (file) => {
                            try {
                                const contentResponse = await fetch(file.download_url);
                                const content = await contentResponse.text();
                                
                                return {
                                    filename: file.name,
                                    sha: file.sha,
                                    content: content,
                                    ...this.parseMarkdownMeta(content)
                                };
                            } catch (error) {
                                console.warn(`Failed to load ${file.name}:`, error);
                                return null;
                            }
                        })
                    );
                    
                    this.posts = this.posts
                        .filter(post => post !== null)
                        .sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    this.renderPostsList();
                    
                } catch (error) {
                    console.error('Error loading posts:', error);
                    this.showMessage('error', 'Failed to load posts: ' + error.message);
                } finally {
                    this.postsLoading.style.display = 'none';
                }
            }

            parseMarkdownMeta(content) {
                const frontmatterRegex = /^---\n([\s\S]*?)\n---\n([\s\S]*)$/;
                const match = content.match(frontmatterRegex);
                
                let title = 'Untitled';
                let date = new Date().toISOString().split('T')[0];
                let bodyContent = content;

                if (match) {
                    const frontmatter = match[1];
                    bodyContent = match[2];
                    
                    const titleMatch = frontmatter.match(/^title:\s*(.+)$/m);
                    const dateMatch = frontmatter.match(/^date:\s*(.+)$/m);
                    
                    if (titleMatch) title = titleMatch[1].trim().replace(/['"]/g, '');
                    if (dateMatch) date = dateMatch[1].trim();
                }

                return { title, date, bodyContent };
            }

            renderPostsList() {
                if (this.posts.length === 0) {
                    this.postsList.innerHTML = '<li style="text-align: center; color: #6c757d;">No posts found</li>';
                    return;
                }

                this.postsList.innerHTML = this.posts.map(post => `
                    <li>
                        <div>
                            <div>${this.escapeHtml(post.title)}</div>
                            <div class="post-meta">${post.date}</div>
                        </div>
                        <button class="btn" onclick="admin.editPost('${post.filename}')">
                            Edit
                        </button>
                    </li>
                `).join('');
            }

            createNewPost() {
                this.isNewPost = true;
                this.currentPost = null;
                
                this.postTitle.value = '';
                this.postDate.value = new Date().toISOString().split('T')[0];
                this.postContent.value = '';
                
                this.showEditor();
            }

            editPost(filename) {
                const post = this.posts.find(p => p.filename === filename);
                if (!post) return;
                
                this.isNewPost = false;
                this.currentPost = post;
                
                this.postTitle.value = post.title;
                this.postDate.value = post.date;
                this.postContent.value = post.bodyContent;
                
                this.showEditor();
            }

            async savePost() {
                const title = this.postTitle.value.trim();
                const date = this.postDate.value;
                const content = this.postContent.value.trim();
                
                if (!title || !date || !content) {
                    this.showMessage('error', 'Please fill in all fields');
                    return;
                }
                
                try {
                    const filename = this.isNewPost 
                        ? this.generateFilename(title, date)
                        : this.currentPost.filename;
                    
                    const markdownContent = this.buildMarkdownContent(title, date, content);
                    
                    await this.commitFile(filename, markdownContent);
                    
                    this.showMessage('success', 'Post saved successfully!');
                    await this.loadPosts();
                    this.cancelEdit();
                    
                } catch (error) {
                    console.error('Error saving post:', error);
                    this.showMessage('error', 'Failed to save post: ' + error.message);
                }
            }

            async deletePost() {
                if (this.isNewPost || !this.currentPost) return;
                
                if (!confirm(`Are you sure you want to delete "${this.currentPost.title}"?`)) {
                    return;
                }
                
                try {
                    await this.commitFile(this.currentPost.filename, null, this.currentPost.sha);
                    
                    this.showMessage('success', 'Post deleted successfully!');
                    await this.loadPosts();
                    this.cancelEdit();
                    
                } catch (error) {
                    console.error('Error deleting post:', error);
                    this.showMessage('error', 'Failed to delete post: ' + error.message);
                }
            }

            async commitFile(filename, content, sha = null) {
                const path = `${this.postsPath}/${filename}`;
                const message = content 
                    ? `${this.isNewPost ? 'Add' : 'Update'} post: ${this.postTitle.value}`
                    : `Delete post: ${this.currentPost.title}`;
                
                const requestBody = {
                    message: message,
                    committer: {
                        name: this.currentUser.name || this.currentUser.login,
                        email: this.currentUser.email || `${this.currentUser.login}@users.noreply.github.com`
                    }
                };
                
                if (content) {
                    requestBody.content = btoa(unescape(encodeURIComponent(content)));
                }
                
                if (sha) {
                    requestBody.sha = sha;
                }
                
                const response = await fetch(
                    `https://api.github.com/repos/${this.owner}/${this.repo}/contents/${path}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${this.accessToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    }
                );
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `GitHub API error: ${response.status}`);
                }
            }

            generateFilename(title, date) {
                const slug = title
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '');
                return `${date}-${slug}.md`;
            }

            buildMarkdownContent(title, date, content) {
                return `---
title: "${title}"
date: ${date}
---

${content}`;
            }

            cancelEdit() {
                this.showWelcome();
                this.currentPost = null;
                this.isNewPost = false;
                this.clearMessages();
            }

            showLogin() {
                this.loginScreen.style.display = 'block';
                this.adminInterface.style.display = 'none';
            }

            showAdmin() {
                this.loginScreen.style.display = 'none';
                this.adminInterface.style.display = 'block';
            }

            showWelcome() {
                this.welcomeView.style.display = 'block';
                this.editorView.style.display = 'none';
            }

            showEditor() {
                this.welcomeView.style.display = 'none';
                this.editorView.style.display = 'block';
                this.deleteBtn.style.display = this.isNewPost ? 'none' : 'inline-block';
                this.clearMessages();
            }

            showLoginError(message) {
                this.loginError.textContent = message;
                this.loginError.style.display = 'block';
            }

            showMessage(type, message) {
                const className = type === 'error' ? 'error' : 'success';
                this.editorMessages.innerHTML = `<div class="${className}">${this.escapeHtml(message)}</div>`;
            }

            clearMessages() {
                this.editorMessages.innerHTML = '';
                this.loginError.style.display = 'none';
            }

            logout() {
                this.accessToken = null;
                this.currentUser = null;
                localStorage.removeItem('github_token');
                
                this.showLogin();
                this.clearMessages();
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize simple admin interface
        const admin = new SimpleGitHubAdmin();
    </script>
</body>
</html>