<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading Tips - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 1rem;
        }

        .login-screen {
            max-width: 400px;
            margin: 5rem auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .admin-interface {
            display: none;
        }

        .header {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            height: fit-content;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .content-area {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9rem;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        textarea.form-control {
            min-height: 300px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
        }

        .post-list {
            list-style: none;
        }

        .post-list li {
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .post-list li:hover {
            background: #f8f9fa;
        }

        .post-meta {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .editor-actions {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <h1>Loading Tips Admin</h1>
        <p style="margin: 1rem 0; color: #6c757d;">
            GitHub authentication required
        </p>
        <button id="login-btn" class="btn">
            Login with GitHub
        </button>
        <div id="login-error" class="error" style="display: none; margin-top: 1rem;"></div>
    </div>

    <!-- Admin Interface -->
    <div id="admin-interface" class="admin-interface">
        <div class="container">
            <div class="header">
                <h1>Loading Tips Admin</h1>
                <div class="user-info">
                    <img id="user-avatar" class="avatar" src="" alt="User Avatar">
                    <div>
                        <div id="user-name">Loading...</div>
                        <button id="logout-btn" class="btn btn-secondary btn-sm">Logout</button>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="sidebar">
                    <h3>Posts</h3>
                    <button id="new-post-btn" class="btn" style="margin-bottom: 1rem; width: 100%;">
                        New Post
                    </button>
                    
                    <div id="posts-loading" class="loading" style="display: none;">Loading posts...</div>
                    <ul id="posts-list" class="post-list"></ul>
                </div>

                <div class="content-area">
                    <div id="welcome-view">
                        <h2>Welcome to the Admin Panel</h2>
                        <p>Select a post from the sidebar to edit, or click "New Post" to create a new one.</p>
                    </div>

                    <div id="editor-view" style="display: none;">
                        <div class="editor-actions">
                            <button id="save-btn" class="btn">Save Post</button>
                            <button id="delete-btn" class="btn btn-danger">Delete Post</button>
                            <button id="cancel-btn" class="btn btn-secondary">Cancel</button>
                        </div>

                        <div id="editor-messages"></div>

                        <form id="post-form">
                            <div class="form-group">
                                <label for="post-title">Title</label>
                                <input type="text" id="post-title" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="post-date">Date</label>
                                <input type="date" id="post-date" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="post-content">Content (Markdown)</label>
                                <textarea id="post-content" class="form-control" required 
                                    placeholder="Write your post content in Markdown..."></textarea>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class GitHubBlogAdmin {
            constructor() {
                // SECURITY: OAuth configuration
                // Client ID is safe to expose in frontend code
                this.clientId = 'Ov23li5yYWJ44M3ZbNUz'; // Your GitHub OAuth App Client ID
                this.redirectUri = 'https://sarthakg.tech/Loading-tips/callback.html';
                
                // Repository configuration
                this.owner = 'Syrthax'; // Your GitHub username
                this.repo = 'Loading-tips';   // Repository name (matches GitHub repo)
                this.postsPath = 'posts';     // Path to posts directory
                
                // CRITICAL SECURITY: Only allow this specific GitHub username
                this.allowedUser = 'Syrthax'; // Only this GitHub username can access admin
                
                // SECURITY: Access token stored only in memory
                // Will be cleared on page refresh or logout
                this.accessToken = localStorage.getItem('github_token');
                
                this.currentUser = null;
                this.posts = [];
                this.currentPost = null;
                this.isNewPost = false;
                
                this.initElements();
                this.bindEvents();
                
                // Check if we're returning from OAuth
                this.handleOAuthCallback();
            }

            initElements() {
                this.loginScreen = document.getElementById('login-screen');
                this.adminInterface = document.getElementById('admin-interface');
                this.loginBtn = document.getElementById('login-btn');
                this.logoutBtn = document.getElementById('logout-btn');
                this.loginError = document.getElementById('login-error');
                
                this.userAvatar = document.getElementById('user-avatar');
                this.userName = document.getElementById('user-name');
                
                this.postsLoading = document.getElementById('posts-loading');
                this.postsList = document.getElementById('posts-list');
                this.newPostBtn = document.getElementById('new-post-btn');
                
                this.welcomeView = document.getElementById('welcome-view');
                this.editorView = document.getElementById('editor-view');
                this.editorMessages = document.getElementById('editor-messages');
                
                this.postForm = document.getElementById('post-form');
                this.postTitle = document.getElementById('post-title');
                this.postDate = document.getElementById('post-date');
                this.postContent = document.getElementById('post-content');
                
                this.saveBtn = document.getElementById('save-btn');
                this.deleteBtn = document.getElementById('delete-btn');
                this.cancelBtn = document.getElementById('cancel-btn');
            }

            bindEvents() {
                this.loginBtn.addEventListener('click', () => this.initiateLogin());
                this.logoutBtn.addEventListener('click', () => this.logout());
                this.newPostBtn.addEventListener('click', () => this.createNewPost());
                this.saveBtn.addEventListener('click', () => this.savePost());
                this.deleteBtn.addEventListener('click', () => this.deletePost());
                this.cancelBtn.addEventListener('click', () => this.cancelEdit());
            }

            async handleOAuthCallback() {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                
                if (code) {
                    // Clear URL parameters
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    try {
                        await this.exchangeCodeForToken(code);
                    } catch (error) {
                        this.showLoginError('OAuth authentication failed: ' + error.message);
                    }
                }
                
                if (this.accessToken) {
                    await this.initializeAdmin();
                } else {
                    this.showLogin();
                }
            }

            async exchangeCodeForToken(code) {
                // This method is no longer used - OAuth exchange happens in GitHub Actions
                // The callback.html page handles the OAuth flow securely
                throw new Error('OAuth exchange is handled by callback.html and GitHub Actions');
            }

            initiateLogin() {
                // SECURITY: Generate cryptographically secure state for CSRF protection
                const state = this.generateRandomString();
                localStorage.setItem('oauth_state', state);
                
                // Clear any existing auth data
                localStorage.removeItem('github_token');
                localStorage.removeItem('github_user');
                localStorage.removeItem('auth_timestamp');
                
                const authUrl = `https://github.com/login/oauth/authorize?` +
                    `client_id=${this.clientId}&` +
                    `redirect_uri=${encodeURIComponent(this.redirectUri)}&` +
                    `scope=repo&` +
                    `state=${state}&` +
                    `allow_signup=false`; // Only existing users
                
                console.log('Redirecting to GitHub OAuth...');
                window.location.href = authUrl;
            }

            generateRandomString() {
                const array = new Uint32Array(28);
                crypto.getRandomValues(array);
                return Array.from(array, dec => ('0' + dec.toString(16)).substr(-2)).join('');
            }

            async initializeAdmin() {
                try {
                    // Check if we have recent authentication data
                    const authTimestamp = localStorage.getItem('auth_timestamp');
                    const currentTime = Date.now();
                    const eightHours = 8 * 60 * 60 * 1000; // 8 hours in milliseconds
                    
                    if (authTimestamp && (currentTime - parseInt(authTimestamp)) > eightHours) {
                        // Token expired, clear auth data
                        this.logout();
                        return;
                    }
                    
                    // Verify user identity and permissions
                    await this.verifyUser();
                    this.showAdmin();
                    await this.loadPosts();
                } catch (error) {
                    console.error('Admin initialization error:', error);
                    this.showLoginError('Authentication failed: ' + error.message);
                    this.logout();
                }
            }

            async verifyUser() {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${this.accessToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Invalid access token');
                }

                this.currentUser = await response.json();
                
                // CRITICAL SECURITY: Verify user identity
                if (this.currentUser.login !== this.allowedUser) {
                    throw new Error(`Access denied. Only ${this.allowedUser} is authorized.`);
                }
                
                this.updateUserInfo();
            }

            updateUserInfo() {
                this.userAvatar.src = this.currentUser.avatar_url;
                this.userName.textContent = this.currentUser.name || this.currentUser.login;
            }

            async loadPosts() {
                this.postsLoading.style.display = 'block';
                this.postsList.innerHTML = '';
                
                try {
                    const response = await fetch(
                        `https://api.github.com/repos/${this.owner}/${this.repo}/contents/${this.postsPath}`,
                        {
                            headers: {
                                'Authorization': `token ${this.accessToken}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );

                    if (!response.ok) {
                        if (response.status === 404) {
                            // Posts directory doesn't exist yet - that's okay
                            this.posts = [];
                            this.renderPostsList();
                            return;
                        }
                        throw new Error(`Failed to load posts: ${response.status}`);
                    }

                    const files = await response.json();
                    
                    // Filter for markdown files and fetch their content
                    const postFiles = files.filter(file => 
                        file.type === 'file' && file.name.endsWith('.md')
                    );

                    this.posts = await Promise.all(
                        postFiles.map(async (file) => {
                            try {
                                const contentResponse = await fetch(file.download_url);
                                const content = await contentResponse.text();
                                
                                return {
                                    filename: file.name,
                                    sha: file.sha,
                                    content: content,
                                    ...this.parseMarkdownMeta(content)
                                };
                            } catch (error) {
                                console.warn(`Failed to load ${file.name}:`, error);
                                return null;
                            }
                        })
                    );
                    
                    this.posts = this.posts
                        .filter(post => post !== null)
                        .sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    this.renderPostsList();
                    
                } catch (error) {
                    console.error('Error loading posts:', error);
                    this.showMessage('error', 'Failed to load posts: ' + error.message);
                } finally {
                    this.postsLoading.style.display = 'none';
                }
            }

            parseMarkdownMeta(content) {
                const frontmatterRegex = /^---\n([\s\S]*?)\n---\n([\s\S]*)$/;
                const match = content.match(frontmatterRegex);
                
                let title = 'Untitled';
                let date = new Date().toISOString().split('T')[0];
                let bodyContent = content;

                if (match) {
                    const frontmatter = match[1];
                    bodyContent = match[2];
                    
                    const titleMatch = frontmatter.match(/^title:\s*(.+)$/m);
                    const dateMatch = frontmatter.match(/^date:\s*(.+)$/m);
                    
                    if (titleMatch) title = titleMatch[1].trim().replace(/['"]/g, '');
                    if (dateMatch) date = dateMatch[1].trim();
                }

                return { title, date, bodyContent };
            }

            renderPostsList() {
                if (this.posts.length === 0) {
                    this.postsList.innerHTML = '<li style="text-align: center; color: #6c757d;">No posts found</li>';
                    return;
                }

                this.postsList.innerHTML = this.posts.map(post => `
                    <li>
                        <div>
                            <div>${this.escapeHtml(post.title)}</div>
                            <div class="post-meta">${post.date}</div>
                        </div>
                        <button class="btn btn-sm" onclick="admin.editPost('${post.filename}')">
                            Edit
                        </button>
                    </li>
                `).join('');
            }

            createNewPost() {
                this.isNewPost = true;
                this.currentPost = null;
                
                // Set default values
                this.postTitle.value = '';
                this.postDate.value = new Date().toISOString().split('T')[0];
                this.postContent.value = '';
                
                this.showEditor();
            }

            editPost(filename) {
                const post = this.posts.find(p => p.filename === filename);
                if (!post) return;
                
                this.isNewPost = false;
                this.currentPost = post;
                
                this.postTitle.value = post.title;
                this.postDate.value = post.date;
                this.postContent.value = post.bodyContent;
                
                this.showEditor();
            }

            async savePost() {
                const title = this.postTitle.value.trim();
                const date = this.postDate.value;
                const content = this.postContent.value.trim();
                
                if (!title || !date || !content) {
                    this.showMessage('error', 'Please fill in all fields');
                    return;
                }
                
                try {
                    const filename = this.isNewPost 
                        ? this.generateFilename(title, date)
                        : this.currentPost.filename;
                    
                    const markdownContent = this.buildMarkdownContent(title, date, content);
                    
                    await this.commitFile(filename, markdownContent);
                    
                    this.showMessage('success', 'Post saved successfully!');
                    await this.loadPosts();
                    this.cancelEdit();
                    
                } catch (error) {
                    console.error('Error saving post:', error);
                    this.showMessage('error', 'Failed to save post: ' + error.message);
                }
            }

            async deletePost() {
                if (this.isNewPost || !this.currentPost) return;
                
                if (!confirm(`Are you sure you want to delete "${this.currentPost.title}"?`)) {
                    return;
                }
                
                try {
                    await this.commitFile(this.currentPost.filename, null, this.currentPost.sha);
                    
                    this.showMessage('success', 'Post deleted successfully!');
                    await this.loadPosts();
                    this.cancelEdit();
                    
                } catch (error) {
                    console.error('Error deleting post:', error);
                    this.showMessage('error', 'Failed to delete post: ' + error.message);
                }
            }

            async commitFile(filename, content, sha = null) {
                const path = `${this.postsPath}/${filename}`;
                const message = content 
                    ? `${this.isNewPost ? 'Add' : 'Update'} post: ${this.postTitle.value}`
                    : `Delete post: ${this.currentPost.title}`;
                
                const requestBody = {
                    message: message,
                    committer: {
                        name: this.currentUser.name || this.currentUser.login,
                        email: this.currentUser.email || `${this.currentUser.login}@users.noreply.github.com`
                    }
                };
                
                if (content) {
                    requestBody.content = btoa(unescape(encodeURIComponent(content)));
                }
                
                if (sha) {
                    requestBody.sha = sha;
                }
                
                const response = await fetch(
                    `https://api.github.com/repos/${this.owner}/${this.repo}/contents/${path}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${this.accessToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    }
                );
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `GitHub API error: ${response.status}`);
                }
            }

            generateFilename(title, date) {
                const slug = title
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '');
                return `${date}-${slug}.md`;
            }

            buildMarkdownContent(title, date, content) {
                return `---
title: "${title}"
date: ${date}
---

${content}`;
            }

            cancelEdit() {
                this.showWelcome();
                this.currentPost = null;
                this.isNewPost = false;
                this.clearMessages();
            }

            showLogin() {
                this.loginScreen.style.display = 'block';
                this.adminInterface.style.display = 'none';
            }

            showAdmin() {
                this.loginScreen.style.display = 'none';
                this.adminInterface.style.display = 'block';
            }

            showWelcome() {
                this.welcomeView.style.display = 'block';
                this.editorView.style.display = 'none';
            }

            showEditor() {
                this.welcomeView.style.display = 'none';
                this.editorView.style.display = 'block';
                this.deleteBtn.style.display = this.isNewPost ? 'none' : 'inline-block';
                this.clearMessages();
            }

            showLoginError(message) {
                this.loginError.textContent = message;
                this.loginError.style.display = 'block';
            }

            showMessage(type, message) {
                const className = type === 'error' ? 'error' : 'success';
                this.editorMessages.innerHTML = `<div class="${className}">${this.escapeHtml(message)}</div>`;
            }

            clearMessages() {
                this.editorMessages.innerHTML = '';
            }

            logout() {
                // SECURITY: Clear all authentication data
                this.accessToken = null;
                this.currentUser = null;
                localStorage.removeItem('github_token');
                localStorage.removeItem('oauth_state');
                
                this.showLogin();
                this.loginError.style.display = 'none';
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize admin interface
        const admin = new GitHubBlogAdmin();

        // SECURITY NOTE: In production, you would also implement:
        // - CSRF protection
        // - Content Security Policy headers
        // - Rate limiting
        // - Input validation and sanitization
        // - Proper error handling without information disclosure
        // - Audit logging of admin actions
    </script>
</body>
</html>